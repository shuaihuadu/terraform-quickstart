# VM æ¨¡å— - å•è™šæ‹Ÿæœºéƒ¨ç½²

åœ¨ Azure ä¸Šå¿«é€Ÿéƒ¨ç½²å•ä¸ª Linux è™šæ‹Ÿæœºï¼Œæ”¯æŒå¤šç§ç£ç›˜ç±»å‹å’Œç½‘ç»œé…ç½®ã€‚

## åŠŸèƒ½ç‰¹æ€§

- âœ… å• Linux VM éƒ¨ç½²
- âœ… **SSH å¯†é’¥è®¤è¯** (æ¨è) + å¯†ç è®¤è¯
- âœ… æ”¯æŒå¤šç§ç£ç›˜ç±»å‹ (Premium_LRS, PremiumV2_LRS, StandardSSD_LRS)
- âœ… å¯é€‰å…¬ç½‘ IP
- âœ… å¯é€‰æ•°æ®ç£ç›˜
- âœ… å¯ç”¨åŒºæ”¯æŒ
- âœ… NSG è‡ªåŠ¨é…ç½® (SSH)

## å¿«é€Ÿå¼€å§‹

### 1. ç”Ÿæˆ SSH å¯†é’¥ (æ¨è)

> ğŸ’¡ **ä¸ºä»€ä¹ˆè¦ç”Ÿæˆ SSH å¯†é’¥ï¼Ÿ**
> 
> SSH å¯†é’¥ç”¨äº **VM éƒ¨ç½²æ—¶çš„èº«ä»½è®¤è¯**ã€‚Terraform ä¼šå°†å…¬é’¥éƒ¨ç½²åˆ° VMï¼Œä¹‹åä½ å¯ä»¥ç”¨ç§é’¥å…å¯†ç™»å½•ã€‚
> 
> ç›¸æ¯”å¯†ç è®¤è¯çš„ä¼˜åŠ¿ï¼š
> - **æ›´å®‰å…¨**: 4096 ä½åŠ å¯†ï¼Œæš´åŠ›ç ´è§£å‡ ä¹ä¸å¯èƒ½
> - **æ›´ä¾¿æ·**: æ— éœ€æ¯æ¬¡è¾“å…¥å¯†ç 
> - **æ”¯æŒè‡ªåŠ¨åŒ–**: CI/CD å’Œè„šæœ¬å¯æ— äººå€¼å®ˆæ‰§è¡Œ
> - **å¯å®¡è®¡**: ä¸åŒå¯†é’¥å¯è¿½è¸ªä¸åŒç”¨æˆ·
>
> è¯¦ç»†è¯´æ˜è¯·å‚è€ƒä¸‹æ–¹ã€Œ[SSH å¯†é’¥è®¤è¯è¯´æ˜](#ssh-å¯†é’¥è®¤è¯è¯´æ˜)ã€ç« èŠ‚ã€‚

```bash
# ç”Ÿæˆ RSA 4096 ä½å¯†é’¥å¯¹
ssh-keygen -t rsa -b 4096 -f keys/id_rsa -N ""
```

ç”Ÿæˆçš„æ–‡ä»¶ï¼š
- `keys/id_rsa` - ç§é’¥ (ä¿å¯†ï¼Œç”¨äº SSH ç™»å½•)
- `keys/id_rsa.pub` - å…¬é’¥ (éƒ¨ç½²åˆ° VM)

### 2. é…ç½®å¯†ç  (å¯é€‰)

å¦‚æœéœ€è¦åŒæ—¶æ”¯æŒå¯†ç ç™»å½•ï¼ˆç”¨äºæ§åˆ¶å°æˆ–ç´§æ€¥æ¢å¤ï¼‰ï¼Œä»æ¨¡æ¿åˆ›å»º `.env` æ–‡ä»¶ï¼š

```bash
cp .env.template .env
# ç¼–è¾‘ .env ä¿®æ”¹å¯†ç 
```

éƒ¨ç½²æ—¶ä¼šè‡ªåŠ¨é€šè¿‡ Azure CLI run-command è®¾ç½®å¯†ç ã€‚

> âš ï¸ **å®‰å…¨æç¤º**: `.env` æ–‡ä»¶å·²åœ¨ `.gitignore` ä¸­ï¼Œä¸ä¼šè¢«æäº¤åˆ° Gitã€‚

### 3. ä¿®æ”¹é…ç½®

ç¼–è¾‘ `terraform.tfvars` æ–‡ä»¶ï¼š

```hcl
# åŸºç¡€é…ç½®
location = "westus3"
vm_size  = "Standard_D4s_v5"
vm_name  = "my-vm"

# å¯ç”¨å…¬ç½‘ IP
enable_public_ip = true

# æ·»åŠ æ•°æ®ç£ç›˜ (å¯é€‰)
data_disk_size_gb = 100
data_disk_type    = "Premium_LRS"
```

### 4. éƒ¨ç½²

```bash
make deploy
```

### 5. è¿æ¥ VM

éƒ¨ç½²å®Œæˆåä¼šè¾“å‡º SSH è¿æ¥å‘½ä»¤ï¼š

```bash
# ä½¿ç”¨ SSH å¯†é’¥è¿æ¥ (æ¨è)
ssh -i keys/id_rsa <username>@<public-ip>

# æˆ–ä½¿ç”¨å¯†ç è¿æ¥ (å¦‚æœå·²é…ç½®)
ssh <username>@<public-ip>
```

### 6. é”€æ¯

```bash
make destroy
```

## å¯ç”¨å‘½ä»¤

```bash
make help     # æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
make clean    # æ¸…ç† Terraform æ–‡ä»¶
make deploy   # éƒ¨ç½²åŸºç¡€è®¾æ–½
make destroy  # é”€æ¯æ‰€æœ‰èµ„æº
```

## é…ç½®è¯´æ˜

| å˜é‡                  | è¯´æ˜                | é»˜è®¤å€¼                |
| --------------------- | ------------------- | --------------------- |
| `location`            | Azure åŒºåŸŸ          | `westus3`             |
| `vm_size`             | VM è§„æ ¼             | `Standard_D4s_v5`     |
| `vm_name`             | VM åç§°             | `vm-demo`             |
| `admin_username`      | ç®¡ç†å‘˜ç”¨æˆ·å        | `azureuser`           |
| `zone`                | å¯ç”¨åŒº (1/2/3/null) | `null`                |
| `os_disk_size_gb`     | OS ç£ç›˜å¤§å°(GB)     | `256`                 |
| `os_disk_type`        | OS ç£ç›˜ç±»å‹         | `Premium_LRS`         |
| `data_disk_size_gb`   | æ•°æ®ç£ç›˜å¤§å°(GB)    | `null` (ä¸åˆ›å»º)       |
| `data_disk_type`      | æ•°æ®ç£ç›˜ç±»å‹        | `Premium_LRS`         |
| `enable_public_ip`    | æ˜¯å¦åˆ›å»ºå…¬ç½‘ IP     | `true`                |
| `ssh_public_key_file` | SSH å…¬é’¥æ–‡ä»¶è·¯å¾„    | `null` (ä½¿ç”¨å¯†ç è®¤è¯) |

## ä½¿ç”¨ Premium SSD v2

å¦‚éœ€é«˜æ€§èƒ½æ•°æ®ç£ç›˜ï¼š

```hcl
zone              = "1"           # å¿…é¡»æŒ‡å®šå¯ç”¨åŒº
data_disk_size_gb = 100
data_disk_type    = "PremiumV2_LRS"
data_disk_iops    = 5000
data_disk_mbps    = 200
```

## éƒ¨ç½²åéªŒè¯

```bash
# æŸ¥çœ‹ VM
az vm list -g rg-vm-demo -o table

# æŸ¥çœ‹ç£ç›˜
az disk list -g rg-vm-demo -o table

# æŸ¥çœ‹å…¬ç½‘ IP
az network public-ip list -g rg-vm-demo -o table
```

## æ–‡ä»¶ç»“æ„

```
vm/
â”œâ”€â”€ Makefile           # æ„å»ºå‘½ä»¤
â”œâ”€â”€ main.tf            # Terraform ä¸»é…ç½®
â”œâ”€â”€ variables.tf       # å˜é‡å®šä¹‰
â”œâ”€â”€ outputs.tf         # è¾“å‡ºå®šä¹‰
â”œâ”€â”€ terraform.tfvars   # é…ç½®æ–‡ä»¶ï¼ˆä¿®æ”¹è¿™ä¸ªï¼ï¼‰
â”œâ”€â”€ README.md          # æœ¬æ–‡ä»¶
â”œâ”€â”€ .env.template      # å¯†ç é…ç½®æ¨¡æ¿
â”œâ”€â”€ .env               # å¯†ç é…ç½® (gitignore, ä»æ¨¡æ¿å¤åˆ¶)
â”œâ”€â”€ .gitignore         # Git å¿½ç•¥è§„åˆ™
â”œâ”€â”€ keys/              # SSH å¯†é’¥ç›®å½• (gitignore)
â”‚   â”œâ”€â”€ id_rsa         # ç§é’¥
â”‚   â”œâ”€â”€ id_rsa.pub     # å…¬é’¥
â”‚   â””â”€â”€ <user>@<ip>.pem  # ç”Ÿæˆçš„ PEM æ–‡ä»¶ (éƒ¨ç½²åè‡ªåŠ¨ç”Ÿæˆ)
â””â”€â”€ scripts/
    â”œâ”€â”€ set-password.sh  # å¯†ç è®¾ç½®è„šæœ¬
    â””â”€â”€ generate-pem.sh  # PEM æ–‡ä»¶ç”Ÿæˆè„šæœ¬
```

## SSH å¯†é’¥è®¤è¯è¯´æ˜

### ä¸ºä»€ä¹ˆä½¿ç”¨ SSH å¯†é’¥ï¼Ÿ

SSH å¯†é’¥è®¤è¯ç›¸æ¯”å¯†ç è®¤è¯æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š

| ç‰¹æ€§         | SSH å¯†é’¥            | å¯†ç            |
| ------------ | ------------------- | -------------- |
| **å®‰å…¨æ€§**   | âœ… æé«˜ (4096ä½åŠ å¯†) | âš ï¸ å–å†³äºå¤æ‚åº¦ |
| **æš´åŠ›ç ´è§£** | âœ… å‡ ä¹ä¸å¯èƒ½        | âš ï¸ å®¹æ˜“è¢«å°è¯•   |
| **ä¾¿æ·æ€§**   | âœ… å…è¾“å…¥å¯†ç         | âŒ æ¯æ¬¡éœ€è¾“å…¥   |
| **è‡ªåŠ¨åŒ–**   | âœ… æ”¯æŒæ— äººå€¼å®ˆ      | âŒ éœ€äº¤äº’è¾“å…¥   |
| **å®¡è®¡è¿½è¸ª** | âœ… å¯è¿½è¸ªå¯†é’¥ä½¿ç”¨    | âš ï¸ éš¾ä»¥åŒºåˆ†ç”¨æˆ· |

### SSH å¯†é’¥å·¥ä½œåŸç†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æœ¬åœ°ç”µè„‘   â”‚                    â”‚   Azure VM   â”‚
â”‚              â”‚                    â”‚              â”‚
â”‚  ç§é’¥        â”‚ â—„â”€â”€ æ•°å­¦é…å¯¹ â”€â”€â–º  â”‚  å…¬é’¥        â”‚
â”‚  (id_rsa)    â”‚                    â”‚  (å·²éƒ¨ç½²)    â”‚
â”‚              â”‚                    â”‚              â”‚
â”‚  ä¿å¯†ï¼      â”‚                    â”‚  å¯å…¬å¼€      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                                  â”‚
        â””â”€â”€â”€â”€â”€â”€ SSH æ¡æ‰‹éªŒè¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

1. **ç”Ÿæˆå¯†é’¥å¯¹**: ä½¿ç”¨ `ssh-keygen` ç”Ÿæˆå…¬é’¥å’Œç§é’¥
2. **éƒ¨ç½²å…¬é’¥**: Terraform å°†å…¬é’¥éƒ¨ç½²åˆ° VM çš„ `~/.ssh/authorized_keys`
3. **è®¤è¯è¿‡ç¨‹**: SSH å®¢æˆ·ç«¯ç”¨ç§é’¥ç­¾åï¼ŒVM ç”¨å…¬é’¥éªŒè¯
4. **å»ºç«‹è¿æ¥**: éªŒè¯é€šè¿‡åå»ºç«‹åŠ å¯†é€šé“

### å¯†é’¥ç®¡ç†æœ€ä½³å®è·µ

1. **ç§é’¥ä¿å¯†**: æ°¸è¿œä¸è¦åˆ†äº«æˆ–ä¸Šä¼ ç§é’¥åˆ° Git
2. **ä½¿ç”¨å¯†ç ä¿æŠ¤**: ç”Ÿäº§ç¯å¢ƒå»ºè®®ç»™ç§é’¥åŠ å¯†ç  (`ssh-keygen -p`)
3. **å®šæœŸè½®æ¢**: å»ºè®®æ¯å¹´æ›´æ¢å¯†é’¥å¯¹
4. **å¤‡ä»½å¯†é’¥**: å®‰å…¨ä¿å­˜ç§é’¥å¤‡ä»½
5. **æƒé™è®¾ç½®**: ç§é’¥æƒé™åº”ä¸º 600 (`chmod 600 keys/id_rsa`)

### åŒæ—¶æ”¯æŒå¯†ç 

æœ¬æ¨¡å—æ”¯æŒ SSH å¯†é’¥ + å¯†ç åŒé‡è®¤è¯ï¼š

- **SSH å¯†é’¥**: ç”¨äºæ—¥å¸¸ç™»å½•å’Œè‡ªåŠ¨åŒ–
- **å¯†ç **: ç”¨äºæ§åˆ¶å°è®¿é—®æˆ–ç´§æ€¥æ¢å¤

å¯†ç é€šè¿‡ `.env` æ–‡ä»¶é…ç½®ï¼Œéƒ¨ç½²åè‡ªåŠ¨è®¾ç½®ã€‚

## å…±äº« VM è®¿é—®æƒé™

éƒ¨ç½²å®Œæˆåä¼šè‡ªåŠ¨ç”Ÿæˆ `keys/<username>@<public-ip>.pem` æ–‡ä»¶ï¼Œä¾¿äºå…±äº«ã€‚

### æ–¹æ¡ˆä¸€ï¼šå…±äº« PEM ç§é’¥ï¼ˆç®€å•ï¼‰

> âš ï¸ **å®‰å…¨æç¤º**: æ­¤æ–¹å¼é€‚åˆæµ‹è¯•ç¯å¢ƒï¼Œç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨æ–¹æ¡ˆäºŒã€‚

```bash
# éƒ¨ç½²åä¼šè‡ªåŠ¨ç”Ÿæˆ PEM æ–‡ä»¶ï¼Œä¾‹å¦‚:
# keys/shuaihua@57.154.44.243.pem

# 1. å°† .pem æ–‡ä»¶é€šè¿‡å®‰å…¨æ¸ é“å‘é€ç»™å¯¹æ–¹ï¼ˆåˆ‡å‹¿é€šè¿‡é‚®ä»¶/èŠå¤©æ˜æ–‡å‘é€ï¼‰
# 2. å¯¹æ–¹æ”¶åˆ°åè®¾ç½®æƒé™å¹¶è¿æ¥:
chmod 600 shuaihua@57.154.44.243.pem
ssh -i shuaihua@57.154.44.243.pem shuaihua@57.154.44.243
```

**æ³¨æ„äº‹é¡¹**:
- å…±äº«ç§é’¥æ„å‘³ç€æ— æ³•åŒºåˆ†ä¸åŒç”¨æˆ·çš„æ“ä½œ
- å¦‚æœç§é’¥æ³„éœ²ï¼Œéœ€è¦é‡æ–°ç”Ÿæˆå¹¶æ›´æ–°æ‰€æœ‰ç”¨æˆ·
- é€‚åˆå°å›¢é˜Ÿä¸´æ—¶å…±äº«ï¼Œä¸é€‚åˆé•¿æœŸä½¿ç”¨

### æ–¹æ¡ˆäºŒï¼šå¤šç”¨æˆ·ç‹¬ç«‹å¯†é’¥ï¼ˆæ¨èï¼‰

è®©æ¯ä¸ªç”¨æˆ·ç”Ÿæˆè‡ªå·±çš„å¯†é’¥å¯¹ï¼Œç„¶åå°†å…¬é’¥æ·»åŠ åˆ° VMã€‚

**æ­¥éª¤ 1: å¯¹æ–¹ç”Ÿæˆè‡ªå·±çš„å¯†é’¥**

```bash
# å¯¹æ–¹åœ¨è‡ªå·±ç”µè„‘ä¸Šæ‰§è¡Œ:
ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa_azure -N ""
```

**æ­¥éª¤ 2: å¯¹æ–¹å‘é€å…¬é’¥ç»™ä½ **

```bash
# å¯¹æ–¹æŸ¥çœ‹å¹¶å‘é€å…¬é’¥å†…å®¹:
cat ~/.ssh/id_rsa_azure.pub
# è¾“å‡ºç±»ä¼¼: ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQ... user@host
```

**æ­¥éª¤ 3: ä½ å°†å…¬é’¥æ·»åŠ åˆ° VM**

```bash
# æ–¹æ³•1: é€šè¿‡ SSH ç›´æ¥æ·»åŠ 
ssh -i keys/id_rsa shuaihua@57.154.44.243 \
  'echo "ssh-rsa AAAAB3... å¯¹æ–¹çš„å…¬é’¥" >> ~/.ssh/authorized_keys'

# æ–¹æ³•2: ä½¿ç”¨ Azure CLI
az vm user update \
  --resource-group rg-vm-demo \
  --name vm-demo \
  --username newuser \
  --ssh-key-value "ssh-rsa AAAAB3... å¯¹æ–¹çš„å…¬é’¥"
```

**æ­¥éª¤ 4: å¯¹æ–¹è¿æ¥ VM**

```bash
ssh -i ~/.ssh/id_rsa_azure shuaihua@57.154.44.243
```

**ä¼˜åŠ¿**:
- âœ… æ¯ä¸ªç”¨æˆ·æœ‰ç‹¬ç«‹å¯†é’¥ï¼Œå¯è¿½è¸ªæ“ä½œ
- âœ… æ’¤é”€æŸç”¨æˆ·æƒé™åªéœ€åˆ é™¤å…¶å…¬é’¥
- âœ… ç§é’¥ä¸éœ€è¦ä¼ è¾“ï¼Œæ›´å®‰å…¨
- âœ… ç¬¦åˆå®‰å…¨æœ€ä½³å®è·µ
